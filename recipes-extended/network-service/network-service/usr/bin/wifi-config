#!/bin/sh

## global variables
WPA_IFACE="wlan0"

# wpa_supplicant variables
WPA_SUP_BIN="/usr/sbin/wpa_supplicant"
WPA_SUP_PNAME="wpa_supplicant"

# wpa_cli variables
WPA_CLI_BIN="/usr/sbin/wpa_cli"
WPA_CLI_PNAME="wpa_cli"

# udhcpc variables
UDHCPC_BIN="/sbin/udhcpc"
UDHCPC_PNAME="udhcpc"

# ifconfig variables
IFCONFIG_BIN="/sbin/ifconfig"
IFCONFIG_PNAME="ifconfig"

#####################################################################
## wpa_cli wrapper
# Path to common ctrl_interface socket and iface supplied.
# NB: WPA_CTRL_DIR cannot be used for interactive commands, it is
# set only in the environment that wpa_cli provides when processing
# action events.
#
wpa_cli () {
    "$WPA_CLI_BIN" -i "$WPA_IFACE" "$@" 2> /dev/null

    if [ "$?" -ne 0 ]; then
        return 1
    fi

    return 0
}

do_iface_dhcp() {
    local UDHCPC_PID;

    if [ -e /var/run/udhcpc.pid ]; then
        UDHCPC_PID=`cat /var/run/udhcpc.pid`
        kill -9 $UDHCPC_PID
    fi
    # $UDHCPC_BIN -b -R -i $WPA_IFACE -p /var/run/udhcpc.pid
}

do_iface_reset() {
    $IFCONFIG_BIN $WPA_IFACE down
    $IFCONFIG_BIN $WPA_IFACE up
}

do_iface_configure () {
    local SSID;
    local PWD;
    local ENCRYPTO;
    local METHOD;

    SSID=$1
    PWD=$2
    ENCRYPTO=$3
    METHOD=$4

    echo "SSID:$SSID / PWD:$PWD / ENCRYPTO:$ENCRYPTO / METHOD:$METHOD"

    wpa_cli select_network 0
    wpa_cli disable_network 0
    wpa_cli set_network 0 ssid \"$SSID\"
    case $ENCRYPTO in
        1)
            echo "ENCRYPTION:NONE"
            wpa_cli set_network 0 key_mgmt NONE
            ;;
        2)
            echo "ENCRYPTION:WEP"
            wpa_cli set_network 0 wep_key0 \"$PWD\"
            wpa_cli set_network wep_tx_keyidx 0
            ;;
        3)
            echo "ENCRYPTION:WPA"
            wpa_cli set_network 0 psk \"$PWD\"
            wpa_cli set_network 0 key_mgmt WPA-PSK
            ;;
        *)
            echo "Unsupport encryption"
            ;;
    esac

    wpa_cli select_network 0
    wpa_cli enable_network 0

    wpa_cli save_config

    if [ $METHOD -eq 1 ]; then
        echo "METHOD:DHCP"
        do_iface_dhcp
        $UDHCPC_BIN -b -R -i $WPA_IFACE -p /var/run/udhcpc.pid
    else
        echo "METHOD:MANUAL"
        do_iface_dhcp
    fi

    do_iface_reset
}

# quit if executables are not installed
if [ ! -x "$WPA_SUP_BIN" ] || [ ! -x "$WPA_CLI_BIN" ] || [ ! -x "$UDHCPC_BIN" ] || [ ! -x "$IFCONFIG_BIN" ]; then
	exit 0
fi

# Usage: $1 - SSID / $2 - PWD / $3 - ENCRYPTION / $4 - METHOD
do_iface_configure "$1" "$2" $3 $4

exit 0
